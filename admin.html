<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin — CSECV</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="container nav">
        <a href="/" class="brand"><span class="brand-dot"></span>CSECV</a>
        <nav class="main-nav" aria-label="Principal">
          <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/modulos">Módulos</a></li>
          </ul>
        </nav>
        <div class="nav-actions">
          <button class="btn btn-ghost" id="btn-user" style="display:none"></button>
          <button class="btn btn-ghost" id="btn-logout" style="display:none">Salir</button>
        </div>
      </div>
    </header>
    <main class="container" style="padding:24px 0 80px">
      <h1>Panel de administración</h1>
      <p class="muted" id="adminMsg">Cargando...</p>

      <section class="login-card" style="margin-top:18px">
        <h2>Temas</h2>
        <form id="topicForm" style="margin-top:8px; display:grid; gap:10px">
          <div class="row" style="gap:10px; flex-wrap:wrap">
            <label>Slug <input type="text" name="slug" required /></label>
            <label>Título <input type="text" name="title" required /></label>
            <label>Imagen del tema (archivo) <input type="file" name="image" accept="image/*"/></label>
      </div>
          <label>Descripción <input type="text" name="description" /></label>
          <div class="row">
            <button class="btn btn-primary" type="submit">Crear/Actualizar</button>
            <button class="btn btn-ghost" type="button" id="btnDeleteTopic">Eliminar</button>
      </div>
          </form>
        <div id="topicsList" style="margin-top:12px"></div>
      </section>

      <section class="login-card" style="margin-top:18px">
        <h2>Video del tema</h2>
        <form id="videoForm" style="display:grid; gap:10px">
          <div class="row" style="gap:10px; flex-wrap:wrap">
            <label>Slug <input type="text" name="slug" required /></label>
            <label>Título <input type="text" name="title" /></label>
            <label>URL YouTube <input type="text" name="url" placeholder="https://www.youtube.com/watch?v=..." required /></label>
        </div>
          <button class="btn btn-primary" type="submit">Guardar video</button>
          </form>
      </section>

      <section class="login-card" style="margin-top:18px">
        <h2>Noticias del tema</h2>
        <form id="newsForm" style="display:grid; gap:10px">
          <div class="row" style="gap:10px; flex-wrap:wrap">
            <label>Slug <input type="text" name="slug" required /></label>
            <label>Título <input type="text" name="title" required /></label>
            <label>URL <input type="text" name="url" required /></label>
        </div>
          <div class="row" style="gap:10px; flex-wrap:wrap">
            <label>Fuente <input type="text" name="source" /></label>
            <label>Resumen <input type="text" name="summary" /></label>
      </div>
          <button class="btn btn-primary" type="submit">Agregar noticia</button>
          </form>
      </section>

      <section class="login-card" style="margin-top:18px">
        <h2>Cursos del tema</h2>
        <form id="courseForm" style="display:grid; gap:10px">
          <div class="row" style="gap:10px; flex-wrap:wrap">
            <label>Slug <input type="text" name="slug" required /></label>
            <label>Título <input type="text" name="title" required /></label>
            <label>URL <input type="text" name="url" required /></label>
        </div>
          <div class="row" style="gap:10px; flex-wrap:wrap">
            <label>Proveedor <input type="text" name="provider" /></label>
            <label>Resumen <input type="text" name="summary" /></label>
      </div>
          <button class="btn btn-primary" type="submit">Agregar curso</button>
        </form>
      </section>

      <section class="login-card" id="usersSection" style="margin-top:18px; display:none">
        <h2>Usuarios (solo dueño)</h2>
        <div id="usersList"></div>
      </section>
    </main>

    <script src="app.js"></script>
    <script>
      (async function(){
        const msg = document.getElementById('adminMsg');
        const me = await fetch('/api/me').then(r=>r.json()).catch(()=>({authenticated:false}));
        if (!me.authenticated){ msg.textContent = 'Debes iniciar sesión.'; return; }
        const allowedRoles = ['admin','theme_editor','news_editor','course_editor'];
        if (!allowedRoles.includes(me.role)){ msg.textContent = 'No tienes permisos para administrar.'; return; }
        msg.textContent = 'Autorizado ('+ (me.role || 'user') +').';

        async function refreshTopics(){
          const list = document.getElementById('topicsList');
          const res = await fetch('/api/v2/topics');
          const topics = await res.json();
          list.innerHTML = topics.map(t => `
            <div class="admin-item">
              <div class="admin-item-content">
                <strong>${t.title}</strong><div class="muted">Slug: ${t.slug}</div>
                <div class="muted">${t.description||''}</div>
              </div>
              <div class="admin-item-actions">
                <button class="btn btn-ghost btn-small" data-edit="${t.slug}">Editar</button>
                <button class="btn btn-ghost btn-small" data-del="${t.slug}">Eliminar</button>
              </div>
            </div>
          `).join('');

          list.querySelectorAll('[data-edit]').forEach(btn => {
            btn.addEventListener('click', async () => {
              const slug = btn.getAttribute('data-edit');
              const r = await fetch('/api/v2/topics/'+encodeURIComponent(slug));
              if (!r.ok) return; const t = await r.json();
              topicForm.querySelector('input[name="slug"]').value = t.slug;
              topicForm.querySelector('input[name="title"]').value = t.title||'';
              topicForm.querySelector('input[name="description"]').value = t.description||'';
              topicForm.scrollIntoView({ behavior:'smooth', block:'start' });
            });
          });
          list.querySelectorAll('[data-del]').forEach(btn => {
            btn.addEventListener('click', async () => {
              const slug = btn.getAttribute('data-del');
              if (!confirm('¿Eliminar tema '+slug+'?')) return;
              const r = await fetch('/api/v2/topics/'+encodeURIComponent(slug), { method:'DELETE' });
              if (!r.ok){ alert('Error eliminando'); return; }
              await refreshTopics();
            });
          });
        }
        await refreshTopics();

        // Mostrar gestión de usuarios si es owner
        if (me.role === 'owner'){
          const usersSection = document.getElementById('usersSection');
          usersSection.style.display = 'block';
          async function refreshUsers(){
            const box = document.getElementById('usersList');
            const r = await fetch('/api/users');
            const users = await r.json();
            const roles = ['user','news_editor','course_editor','theme_editor','admin'];
            box.innerHTML = users.map(u => `
              <div class="admin-item">
                <div class="admin-item-content">
                  <strong>${u.username||u.email}</strong>
                  <div class="muted">${u.email}</div>
                </div>
                <div class="admin-item-actions">
                  <select data-user="${u.id}">
                    ${roles.map(role => `<option value="${role}" ${u.role===role?'selected':''}>${role}</option>`).join('')}
                  </select>
                  <button class="btn btn-primary btn-small" data-save="${u.id}">Guardar</button>
                </div>
              </div>
            `).join('');
            box.querySelectorAll('[data-save]').forEach(btn => {
              btn.addEventListener('click', async () => {
                const id = btn.getAttribute('data-save');
                const sel = box.querySelector('select[data-user="'+id+'"]');
                const role = sel.value;
                const up = await fetch('/api/users/'+id+'/role', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ role }) });
                alert(up.ok ? 'Rol actualizado' : 'Error actualizando rol');
              });
            });
          }
          refreshUsers();
        }

        document.getElementById('btn-logout').style.display='inline-flex';
        const btnLogout = document.getElementById('btn-logout');
        if (btnLogout) btnLogout.onclick = async ()=>{ await fetch('/api/logout',{method:'POST'}); location.reload(); };

        const topicForm = document.getElementById('topicForm');
        const btnDeleteTopic = document.getElementById('btnDeleteTopic');
        topicForm.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const fd = new FormData(topicForm);
          const slug = fd.get('slug');
          const title = fd.get('title');
          const description = fd.get('description')||'';
          let res = await fetch('/api/v2/topics/'+encodeURIComponent(slug), { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title, description }) });
          if (!res.ok){
            res = await fetch('/api/v2/topics', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ slug, title, description }) });
            if (!res.ok){ alert('Error guardando tema'); return; }
          }
          const file = topicForm.querySelector('input[name="image"]').files[0];
          if (file){
            const imgFd = new FormData(); imgFd.append('image', file);
            await fetch('/api/v2/topics/'+encodeURIComponent(slug)+'/image', { method:'POST', body: imgFd });
          }
          alert('Tema guardado');
          refreshTopics();
        });
        btnDeleteTopic.addEventListener('click', async ()=>{
          const slug = topicForm.querySelector('input[name="slug"]').value; if (!slug) return;
          if (!confirm('¿Eliminar tema '+slug+'?')) return;
          const res = await fetch('/api/v2/topics/'+encodeURIComponent(slug), { method:'DELETE' });
          alert(res.ok ? 'Tema eliminado' : 'Error eliminando');
          refreshTopics();
        });

        const videoForm = document.getElementById('videoForm');
        videoForm.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const data = Object.fromEntries(new FormData(videoForm).entries());
          const res = await fetch('/api/v2/topics/'+encodeURIComponent(data.slug)+'/video', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title:data.title, url:data.url }) });
          alert(res.ok ? 'Video actualizado' : 'Error guardando video');
        });

        const newsForm = document.getElementById('newsForm');
        newsForm.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const data = Object.fromEntries(new FormData(newsForm).entries());
          const res = await fetch('/api/v2/topics/'+encodeURIComponent(data.slug)+'/news', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title:data.title, url:data.url, source:data.source, summary:data.summary }) });
          alert(res.ok ? 'Noticia agregada' : 'Error guardando noticia');
        });

        const courseForm = document.getElementById('courseForm');
        courseForm.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const data = Object.fromEntries(new FormData(courseForm).entries());
          const res = await fetch('/api/v2/topics/'+encodeURIComponent(data.slug)+'/courses', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title:data.title, url:data.url, provider:data.provider, summary:data.summary }) });
          alert(res.ok ? 'Curso agregado' : 'Error guardando curso');
        });
      })();
    </script>
  </body>
  </html>

